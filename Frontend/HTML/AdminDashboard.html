<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - LifeLink</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
        h1 { color: #c41e3a; margin-bottom: 10px; }
        .user-info { background: #f8f8f8; padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; }
        h2 { color: #333; margin-bottom: 15px; font-size: 20px; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #c41e3a; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px 5px 5px 0; }
        button:hover { background: #a01828; }
        .btn-secondary { background: #666; }
        .btn-secondary:hover { background: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f8f8; font-weight: bold; }
        .result { margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px; display: none; }
        .error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <h1>LifeLink - Admin Dashboard</h1>
        <div class="user-info">
            <strong>Role:</strong> Administrator | <button class="btn-secondary" onclick="logout()">Logout</button>
        </div>

        <div class="section">
            <h2>Donor Management</h2>
            <button onclick="getAllDonors()">View All Donors</button>
            <button onclick="getEligibleDonors()">View Eligible Donors</button>
            <button onclick="showAddDonorForm()">Add New Donor</button>
            
            <div id="addDonorForm" style="display:none; margin-top: 15px; background: #f8f8f8; padding: 15px; border-radius: 4px;">
                <h3>Add New Donor</h3>
                <input type="text" id="donorName" placeholder="Full Name">
                <input type="text" id="donorContact" placeholder="Contact Number">
                <input type="text" id="donorAddress" placeholder="Address">
                <select id="donorBloodGroup">
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
                <button onclick="addDonor()">Submit</button>
                <button class="btn-secondary" onclick="hideAddDonorForm()">Cancel</button>
            </div>
            
            <div id="donorResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Blood Inventory</h2>
            <button onclick="getInventory()">View All Inventory</button>
            <button onclick="getExpiringBags()">View Expiring Bags (7 days)</button>
            <button onclick="showAddBloodForm()">Add Blood Bag</button>
            
            <div id="addBloodForm" style="display:none; margin-top: 15px; background: #f8f8f8; padding: 15px; border-radius: 4px;">
                <h3>Add Blood Bag</h3>
                <select id="bagBloodGroup">
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
                <input type="number" id="bagDonorId" placeholder="Donor ID (optional)">
                <button onclick="addBloodBag()">Submit</button>
                <button class="btn-secondary" onclick="hideAddBloodForm()">Cancel</button>
            </div>
            
            <div id="inventoryResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Blood Requests</h2>
            <button onclick="getAllRequests()">View All Requests</button>
            <div id="requestResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Record Donation</h2>
            <input type="number" id="donationDonorId" placeholder="Donor ID">
            <input type="number" id="donationQuantity" placeholder="Quantity (ml)" value="450">
            <textarea id="donationRemarks" placeholder="Health Remarks (optional)"></textarea>
            <button onclick="recordDonation()">Record Donation</button>
            <div id="donationResult" class="result"></div>
        </div>
    </div>

    <script>
        async function getAllDonors() {
            try {
                const response = await fetch('/admin/donors');
                const data = await response.json();
                displayTable(data, 'donorResult', ['donor_id', 'full_name', 'blood_group', 'contact_no', 'last_donation_date']);
            } catch (error) {
                showError('donorResult', error.message);
            }
        }

        async function getEligibleDonors() {
            try {
                const response = await fetch('/admin/donors/eligible');
                const data = await response.json();
                displayTable(data, 'donorResult', ['donor_id', 'full_name', 'blood_group', 'days_since_last_donation']);
            } catch (error) {
                showError('donorResult', error.message);
            }
        }

        function showAddDonorForm() {
            document.getElementById('addDonorForm').style.display = 'block';
        }

        function hideAddDonorForm() {
            document.getElementById('addDonorForm').style.display = 'none';
        }

        async function addDonor() {
            const donor = {
                full_name: document.getElementById('donorName').value,
                contact_no: document.getElementById('donorContact').value,
                address: document.getElementById('donorAddress').value,
                blood_group: document.getElementById('donorBloodGroup').value
            };

            try {
                const response = await fetch('/admin/donors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(donor)
                });
                const data = await response.json();
                showSuccess('donorResult', 'Donor added successfully!');
                hideAddDonorForm();
                getAllDonors();
            } catch (error) {
                showError('donorResult', error.message);
            }
        }

        async function getInventory() {
            try {
                const response = await fetch('/admin/inventory');
                const data = await response.json();
                displayTable(data, 'inventoryResult', ['bag_id', 'blood_group', 'collection_date', 'expiry_date', 'status']);
            } catch (error) {
                showError('inventoryResult', error.message);
            }
        }

        async function getExpiringBags() {
            try {
                const response = await fetch('/admin/inventory/alerts/expiring');
                const data = await response.json();
                displayTable(data, 'inventoryResult', ['bag_id', 'blood_group', 'collection_date', 'expiry_date', 'status']);
            } catch (error) {
                showError('inventoryResult', error.message);
            }
        }

        function showAddBloodForm() {
            document.getElementById('addBloodForm').style.display = 'block';
        }

        function hideAddBloodForm() {
            document.getElementById('addBloodForm').style.display = 'none';
        }

        async function addBloodBag() {
            const bag = {
                blood_group: document.getElementById('bagBloodGroup').value,
                donor_id: document.getElementById('bagDonorId').value || null
            };

            try {
                const response = await fetch('/admin/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bag)
                });
                const data = await response.json();
                showSuccess('inventoryResult', 'Blood bag added successfully!');
                hideAddBloodForm();
                getInventory();
            } catch (error) {
                showError('inventoryResult', error.message);
            }
        }

        async function getAllRequests() {
            try {
                const response = await fetch('/admin/requests');
                const data = await response.json();
                displayTable(data, 'requestResult', ['request_id', 'hospital_name', 'blood_group_needed', 'units_requested', 'urgency', 'status', 'request_date']);
            } catch (error) {
                showError('requestResult', error.message);
            }
        }

        async function recordDonation() {
            const donation = {
                donor_id: document.getElementById('donationDonorId').value,
                quantity_ml: document.getElementById('donationQuantity').value,
                health_remarks: document.getElementById('donationRemarks').value
            };

            try {
                const response = await fetch('/admin/donations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(donation)
                });
                const data = await response.json();
                showSuccess('donationResult', 'Donation recorded successfully!');
                document.getElementById('donationDonorId').value = '';
                document.getElementById('donationRemarks').value = '';
            } catch (error) {
                showError('donationResult', error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (error) {
                alert('Logout failed');
            }
        }

        function displayTable(data, elementId, columns) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';

            if (data.length === 0) {
                resultDiv.innerHTML = '<p>No records found</p>';
                return;
            }

            let html = '<table><tr>';
            columns.forEach(col => {
                html += `<th>${col.replace('_', ' ').toUpperCase()}</th>`;
            });
            html += '</tr>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || '-'}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';
            resultDiv.innerHTML = html;
        }

        function showSuccess(elementId, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<p>${message}</p>`;
        }

        function showError(elementId, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result error';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<p>Error: ${message}</p>`;
        }
    </script>
</body>
</html>