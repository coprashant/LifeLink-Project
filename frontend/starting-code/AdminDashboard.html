<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - LifeLink</title>
    <link rel="stylesheet" href="AdminDashboard.css">
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>LifeLink - Admin Dashboard</h1>
            <div class="user-info">
                <span><strong>Role:</strong> Administrator</span>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <section class="section">
                <h2>Donor Management</h2>
                <div class="button-group">
                    <button onclick="getAllDonors()">View All Donors</button>
                    <button onclick="getEligibleDonors()">View Eligible Donors</button>
                    <button onclick="showAddDonorForm()">Add New Donor</button>
                </div>
                
                <div id="addDonorForm" class="hidden-form">
                    <h3>Add New Donor</h3>
                    <input type="text" id="donorName" placeholder="Full Name">
                    <input type="text" id="donorContact" placeholder="Contact Number">
                    <input type="text" id="donorAddress" placeholder="Address">
                    <select id="donorBloodGroup">
                        <option value="">Select Blood Group</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                    <button onclick="addDonor()">Submit</button>
                    <button class="btn-secondary" onclick="hideAddDonorForm()">Cancel</button>
                </div>
                
                <div id="donorResult" class="result"></div>
            </section>

            <section class="section">
                <h2>Blood Inventory</h2>
                <div class="button-group">
                    <button onclick="getInventory()">View All Inventory</button>
                    <button onclick="getExpiringBags()">View Expiring Bags (7 days)</button>
                    <button onclick="showAddBloodForm()">Add Blood Bag</button>
                </div>
                
                <div id="addBloodForm" class="hidden-form">
                    <h3>Add Blood Bag</h3>
                    <select id="bagBloodGroup">
                        <option value="">Select Blood Group</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                    <input type="number" id="bagDonorId" placeholder="Donor ID (optional)">
                    <button onclick="addBloodBag()">Submit</button>
                    <button class="btn-secondary" onclick="hideAddBloodForm()">Cancel</button>
                </div>
                
                <div id="inventoryResult" class="result"></div>
            </section>

            <section class="section">
                <h2>Blood Requests</h2>
                <button onclick="getAllRequests()">View All Requests</button>
                <div id="requestResult" class="result"></div>
            </section>

            <section class="section">
                <h2>Record Donation</h2>
                <input type="number" id="donationDonorId" placeholder="Donor ID">
                <input type="number" id="donationQuantity" placeholder="Quantity (ml)" value="450">
                <textarea id="donationRemarks" placeholder="Health Remarks (optional)"></textarea>
                <button onclick="recordDonation()">Record Donation</button>
                <div id="donationResult" class="result"></div>
            </section>
        </div>
    </div>

    <script>
        /* [Original JavaScript Logic Preserved] */
        async function getAllDonors() {
            try {
                const response = await fetch('/admin/donors');
                const data = await response.json();
                displayTable(data, 'donorResult', ['donor_id', 'full_name', 'blood_group', 'contact_no', 'last_donation_date']);
            } catch (error) {
                showError('donorResult', error.message);
            }
        }

        async function getEligibleDonors() {
            try {
                const response = await fetch('/admin/donors/eligible');
                const data = await response.json();
                displayTable(data, 'donorResult', ['donor_id', 'full_name', 'blood_group', 'days_since_last_donation']);
            } catch (error) {
                showError('donorResult', error.message);
            }
        }

        function showAddDonorForm() {
            document.getElementById('addDonorForm').style.display = 'block';
        }

        function hideAddDonorForm() {
            document.getElementById('addDonorForm').style.display = 'none';
        }

        async function addDonor() {
            const donor = {
                full_name: document.getElementById('donorName').value,
                contact_no: document.getElementById('donorContact').value,
                address: document.getElementById('donorAddress').value,
                blood_group: document.getElementById('donorBloodGroup').value
            };

            try {
                const response = await fetch('/admin/donors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(donor)
                });
                const data = await response.json();
                showSuccess('donorResult', 'Donor added successfully!');
                hideAddDonorForm();
                getAllDonors();
            } catch (error) {
                showError('donorResult', error.message);
            }
        }

        async function getInventory() {
            try {
                const response = await fetch('/admin/inventory');
                const data = await response.json();
                displayTable(data, 'inventoryResult', ['bag_id', 'blood_group', 'collection_date', 'expiry_date', 'status']);
            } catch (error) {
                showError('inventoryResult', error.message);
            }
        }

        async function getExpiringBags() {
            try {
                const response = await fetch('/admin/inventory/alerts/expiring');
                const data = await response.json();
                displayTable(data, 'inventoryResult', ['bag_id', 'blood_group', 'collection_date', 'expiry_date', 'status']);
            } catch (error) {
                showError('inventoryResult', error.message);
            }
        }

        function showAddBloodForm() {
            document.getElementById('addBloodForm').style.display = 'block';
        }

        function hideAddBloodForm() {
            document.getElementById('addBloodForm').style.display = 'none';
        }

        async function addBloodBag() {
            const bag = {
                blood_group: document.getElementById('bagBloodGroup').value,
                donor_id: document.getElementById('bagDonorId').value || null
            };

            try {
                const response = await fetch('/admin/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bag)
                });
                const data = await response.json();
                showSuccess('inventoryResult', 'Blood bag added successfully!');
                hideAddBloodForm();
                getInventory();
            } catch (error) {
                showError('inventoryResult', error.message);
            }
        }

        async function getAllRequests() {
            try {
                const response = await fetch('/admin/requests');
                const data = await response.json();
                displayTable(data, 'requestResult', ['request_id', 'hospital_name', 'blood_group_needed', 'units_requested', 'urgency', 'status', 'request_date']);
            } catch (error) {
                showError('requestResult', error.message);
            }
        }

        async function recordDonation() {
            const donation = {
                donor_id: document.getElementById('donationDonorId').value,
                quantity_ml: document.getElementById('donationQuantity').value,
                health_remarks: document.getElementById('donationRemarks').value
            };

            try {
                const response = await fetch('/admin/donations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(donation)
                });
                const data = await response.json();
                showSuccess('donationResult', 'Donation recorded successfully!');
                document.getElementById('donationDonorId').value = '';
                document.getElementById('donationRemarks').value = '';
            } catch (error) {
                showError('donationResult', error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (error) {
                alert('Logout failed');
            }
        }

        function displayTable(data, elementId, columns) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';

            if (data.length === 0) {
                resultDiv.innerHTML = '<p>No records found</p>';
                return;
            }

            let html = '<div class="table-container"><table><tr>';
            columns.forEach(col => {
                html += `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`;
            });
            html += '</tr>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || '-'}</td>`;
                });
                html += '</tr>';
            });

            html += '</table></div>';
            resultDiv.innerHTML = html;
        }

        function showSuccess(elementId, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<p class="success-msg">${message}</p>`;
        }

        function showError(elementId, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result error';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<p>Error: ${message}</p>`;
        }
    </script>
</body>
</html>